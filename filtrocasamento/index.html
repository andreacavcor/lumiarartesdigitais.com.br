<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>Filtro Casamento</title>
    <style>
        :root { --accent: #25D366; --record: #ff0000; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: #fff; overflow: hidden; width: 100vw; height: 100dvh; font-family: sans-serif; }

        .frame { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .stage { position: relative; width: 100%; height: 100%; overflow: hidden; background: #000; }

        #camera { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #camera.mirrored { transform: scaleX(-1); }

        /* Canvas de edi√ß√£o e previews */
        #editorCanvas, #canvasPreview, #videoPreview { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; z-index: 6; background: #000; display: none; 
        }

        /* A MOLDURA AGORA TEM Z-INDEX MAIOR PARA FICAR SEMPRE NO TOPO */
        #molduraImagePreview { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: contain; object-position: bottom; 
            pointer-events: none; z-index: 10; display: none; 
        }

        #canvasFinal { display: none; }

        /* Camadas de Interface */
        .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .timer-badge { background: var(--record); color: white; padding: 5px 12px; border-radius: 12px; font-weight: bold; display: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .controls-bottom { display: flex; flex-direction: column; align-items: center; gap: 25px; pointer-events: auto; padding-bottom: 30px; }
        .btn { padding: 10px 16px; font-size: 14px; font-weight: 600; border: 2px solid rgba(255,255,255,0.3); border-radius: 20px; background: rgba(0, 0, 0, 0.65); color: #fff; cursor: pointer; backdrop-filter: blur(4px); }
        .btn-frame { border-color: var(--accent); }
        .action-btn-large { width: 75px; height: 75px; border-radius: 50%; border: 4px solid #fff; background: rgba(255, 255, 255, 0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn-large.recording { border-color: var(--record); background: rgba(255, 0, 0, 0.5); }
        .stop-icon { width: 25px; height: 25px; background: var(--record); border-radius: 4px; display: none; }
        .action-btn-large.recording .stop-icon { display: block; }
        .action-btn-large.recording .cam-icon { display: none; }

        #startScreen { position: absolute; inset: 0; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; background: url('capajpg.jpg') center/cover; }
        #startBtn { padding: 18px 32px; font-size: 20px; background: #FF5722; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }

        #editUI { display: none; z-index: 30; }
        .actions-col { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 300px; pointer-events: auto; }
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #fff; text-align: center; text-decoration: none; }
        .btn-green { background: var(--accent); }
        .btn-gray { background: #555; }
        .flash { position: absolute; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 100; }
    </style>
</head>
<body>

    <div class="frame">
        <div class="stage" id="stage">
            <video id="camera" autoplay playsinline muted></video>
            <canvas id="editorCanvas"></canvas>
            <canvas id="canvasPreview"></canvas>
            <canvas id="canvasFinal"></canvas>
            <video id="videoPreview" playsinline controls></video>
            
            <img id="molduraImagePreview" src="" />
            <div class="flash" id="flash"></div>

            <div class="ui-layer" id="editUI">
                <div style="text-align:center; padding-top:40px; text-shadow: 0 2px 4px #000;"><b>Arraste e use 2 dedos para zoom</b></div>
                <div style="flex:1"></div>
                <div class="actions-col">
                    <button id="confirmEditBtn" class="btn-main btn-green">‚úÖ Confirmar Ajuste</button>
                    <button id="cancelEditBtn" class="btn-main btn-gray">‚ùå Cancelar</button>
                </div>
            </div>

            <div class="ui-layer" id="cameraUI" style="display: none;">
                <div class="top-bar">
                    <button class="btn" id="switchBtn">üîÑ Inverter</button>
                    <div id="recordingTimer" class="timer-badge">00:00</div>
                </div>
                <div class="controls-bottom">
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-frame" id="m1Btn">Foto 1</button>
                        <button class="btn" id="m2Btn">Foto 2</button>
                    </div>
                    <div style="display:flex; align-items:center; gap:25px;">
                        <button id="galleryBtn" class="btn" style="font-size: 24px;">üñºÔ∏è</button>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        <button id="capturePhotoBtn" class="btn" style="font-size: 24px;">üì∑</button>
                        <button id="captureVideoBtn" class="action-btn-large">
                            <svg class="cam-icon" width="30" height="30" viewBox="0 0 24 24" fill="white"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                            <div class="stop-icon"></div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="ui-layer" id="resultUI" style="display: none; justify-content: flex-end; align-items: center;">
                <div class="actions-col">
                    <a id="downloadBtn" class="btn-main btn-green">üì• Baixar Arquivo</a>
                    <button id="newBtn" class="btn-main btn-gray">üîÑ Novo</button>
                </div>
            </div>
        </div>
    </div>

    <div id="startScreen">
        <button id="startBtn">INICIAR C√ÇMERA</button>
    </div>

    <script>
        const MOLDURAS = { 'm1': 'moldura1.png', 'm2': 'moldura2.png' };
        let currentKey = 'm1', isFront = true, stream = null;
        let galleryImg = new Image(), transform = { x: 0, y: 0, sc: 1, lx: 0, ly: 0, ld: 0 };
        let isRecording = false, mediaRecorder = null, recordedChunks = [], recordingStart = 0;
        let isEditing = false, animId = null;

        const video = document.getElementById('camera'), editor = document.getElementById('editorCanvas'), eCtx = editor.getContext('2d');
        const cFinal = document.getElementById('canvasFinal'), ctxF = cFinal.getContext('2d');
        const cPre = document.getElementById('canvasPreview'), ctxP = cPre.getContext('2d');
        const molduraImg = document.getElementById('molduraImagePreview'), fileInput = document.getElementById('fileInput');

        document.getElementById('startBtn').onclick = () => initCamera();
        document.getElementById('switchBtn').onclick = () => { isFront = !isFront; initCamera(); };
        document.getElementById('m1Btn').onclick = (e) => setMoldura(e.target, 'm1');
        document.getElementById('m2Btn').onclick = (e) => setMoldura(e.target, 'm2');
        document.getElementById('galleryBtn').onclick = () => fileInput.click();
        document.getElementById('capturePhotoBtn').onclick = takePhoto;
        document.getElementById('confirmEditBtn').onclick = confirmGalleryEdit;
        document.getElementById('cancelEditBtn').onclick = reset;
        document.getElementById('newBtn').onclick = reset;
        document.getElementById('captureVideoBtn').onclick = () => { if (!isRecording) startRecording(); else stopRecording(); };

        fileInput.onchange = e => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = ev => {
                    galleryImg = new Image();
                    galleryImg.onload = () => {
                        isEditing = true;
                        video.style.display = 'none';
                        document.getElementById('cameraUI').style.display = 'none';
                        document.getElementById('editUI').style.display = 'flex';
                        editor.style.display = 'block';
                        molduraImg.style.display = 'block'; // Garante que a moldura apare√ßa
                        editor.width = stage.clientWidth; editor.height = stage.clientHeight;
                        // Reset transform
                        transform.sc = editor.width / galleryImg.width;
                        transform.x = 0; transform.y = (editor.height - (galleryImg.height * transform.sc)) / 2;
                        renderEditor();
                    };
                    galleryImg.src = ev.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        function renderEditor() {
            if (!isEditing) return;
            eCtx.fillStyle = "#000";
            eCtx.fillRect(0, 0, editor.width, editor.height);
            eCtx.save();
            eCtx.translate(transform.x, transform.y);
            eCtx.scale(transform.sc, transform.sc);
            eCtx.drawImage(galleryImg, 0, 0);
            eCtx.restore();
            // A MOLDURA N√ÉO √â MAIS DESENHADA AQUI, ELA √â UM <IMG> NO HTML
            animId = requestAnimationFrame(renderEditor);
        }

        // Touch controls para o Canvas de Edi√ß√£o
        editor.ontouchstart = e => {
            if (e.touches.length === 1) {
                transform.lx = e.touches[0].clientX - transform.x;
                transform.ly = e.touches[0].clientY - transform.y;
            } else if (e.touches.length === 2) {
                transform.ld = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            }
        };

        editor.ontouchmove = e => {
            e.preventDefault();
            if (e.touches.length === 1) {
                transform.x = e.touches[0].clientX - transform.lx;
                transform.y = e.touches[0].clientY - transform.ly;
            } else if (e.touches.length === 2) {
                const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                transform.sc *= (d / transform.ld);
                transform.ld = d;
            }
        };

        function confirmGalleryEdit() {
            isEditing = false; flash();
            cFinal.width = 1080; cFinal.height = 1920;
            const s = 1080 / editor.width;
            ctxF.fillStyle = "#000"; ctxF.fillRect(0,0,1080,1920);
            ctxF.save();
            ctxF.translate(transform.x * s, transform.y * s);
            ctxF.scale(transform.sc * s, transform.sc * s);
            ctxF.drawImage(galleryImg, 0, 0);
            ctxF.restore();
            drawMolduraFinal(ctxF, 1080, 1920);
            finishProcess('image');
        }

        function takePhoto() {
            flash();
            cFinal.width = 1080; cFinal.height = 1920;
            drawVideoToCanvas(ctxF, 1080, 1920);
            drawMolduraFinal(ctxF, 1080, 1920);
            finishProcess('image');
        }

        function startRecording() {
            isRecording = true;
            document.getElementById('captureVideoBtn').classList.add('recording');
            document.getElementById('recordingTimer').style.display = 'block';
            recordingStart = Date.now(); recordedChunks = [];
            cFinal.width = 720; cFinal.height = 1280;
            const loop = () => {
                if (!isRecording) return;
                drawVideoToCanvas(ctxF, 720, 1280);
                drawMolduraFinal(ctxF, 720, 1280);
                updateTimer();
                requestAnimationFrame(loop);
            };
            loop();
            const cStream = cFinal.captureStream(30);
            if (stream.getAudioTracks().length) cStream.addTrack(stream.getAudioTracks()[0]);
            mediaRecorder = new MediaRecorder(cStream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = () => finishProcess('video');
            mediaRecorder.start();
        }

        function stopRecording() { isRecording = false; document.getElementById('captureVideoBtn').classList.remove('recording'); document.getElementById('recordingTimer').style.display = 'none'; mediaRecorder.stop(); }

        function drawVideoToCanvas(ctx, w, h) {
            ctx.save();
            ctx.translate(w/2, h/2);
            if (isFront) ctx.scale(-1, 1);
            const r = video.videoWidth / video.videoHeight;
            let dw, dh;
            if (r > (w/h)) { dh = h; dw = h * r; } else { dw = w; dh = w / r; }
            ctx.drawImage(video, -dw/2, -dh/2, dw, dh);
            ctx.restore();
        }

        function drawMolduraFinal(ctx, w, h) {
            const ratio = molduraImg.naturalWidth / molduraImg.naturalHeight;
            const th = w / ratio;
            ctx.drawImage(molduraImg, 0, h - th, w, th);
        }

        function finishProcess(type) {
            if (type === 'image') { cFinal.toBlob(b => showResult('image', b), 'image/png'); }
            else { const blob = new Blob(recordedChunks, { type: 'video/webm' }); showResult('video', blob); }
        }

        function showResult(type, blob) {
            const url = URL.createObjectURL(blob);
            video.style.display = 'none'; editor.style.display = 'none'; molduraImg.style.display = 'none';
            document.getElementById('cameraUI').style.display = 'none';
            document.getElementById('editUI').style.display = 'none';
            document.getElementById('resultUI').style.display = 'flex';
            if (type === 'image') {
                document.getElementById('videoPreview').style.display = 'none';
                cPre.style.display = 'block'; cPre.width = stage.clientWidth; cPre.height = stage.clientHeight;
                ctxP.drawImage(cFinal, 0, 0, cPre.width, cPre.height);
            } else {
                cPre.style.display = 'none'; document.getElementById('videoPreview').style.display = 'block';
                document.getElementById('videoPreview').src = url;
            }
            document.getElementById('downloadBtn').href = url;
            document.getElementById('downloadBtn').download = `${type}_${Date.now()}.${type === 'image' ? 'png' : 'webm'}`;
        }

        function reset() {
            isEditing = false; cancelAnimationFrame(animId);
            video.style.display = 'block';
            molduraImg.style.display = 'block';
            document.getElementById('cameraUI').style.display = 'flex';
            document.getElementById('editUI').style.display = 'none';
            document.getElementById('resultUI').style.display = 'none';
            editor.style.display = 'none'; cPre.style.display = 'none';
            document.getElementById('videoPreview').style.display = 'none';
            fileInput.value = "";
        }

        function setMoldura(btn, key) {
            document.querySelectorAll('.btn-frame').forEach(b => b.classList.remove('btn-frame'));
            btn.classList.add('btn-frame');
            currentKey = key; molduraImg.src = MOLDURAS[key];
            molduraImg.style.display = 'block';
        }

        async function initCamera() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: isFront ? 'user' : 'environment' }, audio: true });
                video.srcObject = stream;
                video.classList.toggle('mirrored', isFront);
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('cameraUI').style.display = 'flex';
                setMoldura(document.getElementById('m1Btn'), 'm1');
            } catch (e) { alert("Erro ao acessar c√¢mera."); }
        }

        function updateTimer() { const s = Math.floor((Date.now() - recordingStart) / 1000); document.getElementById('recordingTimer').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function flash() { const f = document.getElementById('flash'); f.style.opacity = '1'; setTimeout(() => f.style.opacity = '0', 150); }
    </script>
</body>
</html>
